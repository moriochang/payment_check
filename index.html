<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¸³å°å·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿å­—é«”ç‚º Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* éš±è— Chrome/Safari çš„æ•¸å­—è¼¸å…¥æ¡†ç®­é ­ (é›–ç„¶å·²æ”¹ç‚º textï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* éš±è— Firefox çš„æ•¸å­—è¼¸å…¥æ¡†ç®­é ­ */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            ğŸ§¾ å°å¸³è¨ˆç®—æ©Ÿ
        </h1>

        <!-- èªªæ˜å€å¡Š -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg mb-6">
            <p class="font-bold mb-1">å°å¸³ç›®æ¨™ï¼šå·®ç•°ç‚º 0</p>
            <!-- æ›´æ–°å…¬å¼é¡¯ç¤º -->
            <p class="text-sm font-semibold">å°å¸³å…¬å¼ï¼šPayment Total - é å”®çµå¸³ - AC+ = SKM + å¤–å¸³</p>
            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                <li><span class="font-bold text-green-700">å·®ç•°ç‚º +</span>: æ–°å…‰å°‘æ”¶éŒ¢ (æˆ–æ˜ç´°æœªé€€)</li>
                <li><span class="font-bold text-red-700">å·®ç•°ç‚º -</span>: æ–°å…‰å¤šæ”¶éŒ¢ (æˆ–æ˜ç´°æœªå…¥)</li>
            </ul>
        </div>

        <div id="inputs-container" class="space-y-4">
            <!-- Payment Total (å·²æ”¹ç‚º type="text" ä¸¦é å·¦) -->
            <div class="input-group">
                <label for="paymentTotal" class="block text-sm font-medium text-gray-700">Payment Total</label>
                <input type="text" id="paymentTotal" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- é å”®çµå¸³ (å·²æ”¹ç‚º type="text" ä¸¦é å·¦) -->
            <div class="input-group">
                <label for="preSaleSettlement" class="block text-sm font-medium text-gray-700">é å”®çµå¸³</label>
                <input type="text" id="preSaleSettlement" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- AC+ (å·²æ”¹ç‚º type="text" ä¸¦é å·¦) -->
            <div class="input-group">
                <label for="acPlus" class="block text-sm font-medium text-gray-700">AC+</label>
                <input type="text" id="acPlus" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- SKM (å·²æ”¹ç‚º type="text" ä¸¦é å·¦) -->
            <div class="input-group">
                <label for="skmAmount" class="block text-sm font-medium text-gray-700">SKM</label>
                <input type="text" id="skmAmount" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>
            
            <!-- å¤–å¸³ (å·²æ”¹ç‚º type="text" ä¸¦é å·¦) -->
            <div class="input-group">
                <label for="externalAccount" class="block text-sm font-medium text-gray-700">å¤–å¸³</label>
                <input type="text" id="externalAccount" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>
        </div>

        <!-- å·®ç•°çµæœé¡¯ç¤º -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 text-center">æœ€çµ‚å·®ç•° (Difference)</h2>
            <div id="difference-display" class="p-5 rounded-xl shadow-inner text-center">
                <!-- å·®ç•°å€¼å°‡åœ¨æ­¤é¡¯ç¤º -->
                <p class="text-5xl font-extrabold font-mono" id="difference-value">0</p>
            </div>
            <p id="reconciliation-status" class="mt-3 text-center text-lg font-medium"></p>
        </div>

        <p id="loading-status" class="mt-4 text-center text-sm text-gray-500">
            <!-- è¼‰å…¥ç‹€æ…‹é¡¯ç¤º -->
            <span class="animate-pulse">æ•¸æ“šè¼‰å…¥ä¸­...</span>
        </p>

    </div>

    <!-- Firebase è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ç‚º Debug (å¯é¸)
        setLogLevel('Debug');

        // --- 1. åˆå§‹åŒ– Firebase ç›¸é—œå¸¸æ•¸å’Œè®Šæ•¸ ---
        let db, auth, userId;
        let isAuthReady = false;
        
        // å¾ Canvas ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // æ›´æ–° INPUT_IDS ä»¥åŒ…å«æ‰€æœ‰æ¬„ä½
        const INPUT_IDS = ['paymentTotal', 'preSaleSettlement', 'acPlus', 'skmAmount', 'externalAccount'];
        const DIFF_VALUE_EL = document.getElementById('difference-value');
        const STATUS_EL = document.getElementById('reconciliation-status');
        const LOADING_EL = document.getElementById('loading-status');
        
        // --- Helper å‡½æ•¸ï¼šè™•ç†æ•¸å­—æ ¼å¼åŒ– ---

        /**
         * ç§»é™¤æ•¸å­—å­—ä¸²ä¸­çš„æ‰€æœ‰éæ•¸å­—å­—ç¬¦ï¼ˆåŒ…å«åƒåˆ†ä½ç¬¦è™Ÿï¼‰ï¼Œä½†ä¿ç•™å°æ•¸é»å’Œè² è™Ÿã€‚
         * @param {string | number} value - å¾…æ¸…ç†çš„å€¼ã€‚
         * @returns {string} æ¸…ç†å¾Œçš„æ•¸å­—å­—ä¸²ã€‚
         */
        function unformatNumber(value) {
            if (typeof value !== 'string') value = String(value);
            // å…è¨±æ•¸å­—ã€å°æ•¸é»å’Œé–‹é ­çš„è² è™Ÿ
            const cleaned = value.replace(/,/g, ''); // ç§»é™¤æ‰€æœ‰é€—è™Ÿ
            return cleaned.replace(/[^0-9.-]/g, '');
        }

        /**
         * å°‡æ•¸å­—æˆ–æ•¸å­—å­—ä¸²æ ¼å¼åŒ–ç‚ºå¸¶æœ‰åƒä½æ•¸åˆ†éš”ç¬¦è™Ÿçš„å­—ä¸²ã€‚
         * @param {string | number} value - å¾…æ ¼å¼åŒ–çš„å€¼ã€‚
         * @returns {string} å¸¶æœ‰åƒåˆ†ä½ç¬¦è™Ÿçš„å­—ä¸²ã€‚
         */
        function formatNumberWithCommas(value) {
            const cleanedValue = unformatNumber(value);
            if (cleanedValue === '' || cleanedValue === '-') return cleanedValue;

            // ä½¿ç”¨ Intl.NumberFormat ç¢ºä¿æº–ç¢ºçš„åƒåˆ†ä½æ ¼å¼
            // ä½¿ç”¨ 'en-US' ç¢ºä¿ä½¿ç”¨é€—è™Ÿä½œç‚ºåƒåˆ†ä½åˆ†éš”ç¬¦
            return new Intl.NumberFormat('en-US').format(parseFloat(cleanedValue));
        }

        // --- 2. æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
        function calculateDifference() {
            // å¾è¼¸å…¥æ¡†ç²å–æ•¸å€¼ (å…ˆå»é™¤åƒåˆ†ä½ç¬¦è™Ÿ)ï¼Œå¦‚æœç‚ºç©ºå‰‡è¦–ç‚º 0
            const paymentTotalStr = unformatNumber(document.getElementById('paymentTotal').value);
            const preSaleSettlementStr = unformatNumber(document.getElementById('preSaleSettlement').value);
            const acPlusStr = unformatNumber(document.getElementById('acPlus').value);
            const skmAmountStr = unformatNumber(document.getElementById('skmAmount').value);
            const externalAccountStr = unformatNumber(document.getElementById('externalAccount').value);

            // è½‰æ›ç‚ºæµ®é»æ•¸é€²è¡Œè¨ˆç®—
            const paymentTotal = parseFloat(paymentTotalStr) || 0;
            const preSaleSettlement = parseFloat(preSaleSettlementStr) || 0;
            const acPlus = parseFloat(acPlusStr) || 0;
            const skmAmount = parseFloat(skmAmountStr) || 0;
            const externalAccount = parseFloat(externalAccountStr) || 0;

            // è¨ˆç®—å·®ç•°ï¼šPayment Total æ¸›å»æ‰€æœ‰è²»ç”¨é …ç›®
            // å·®ç•° = Payment Total - é å”®çµå¸³ - AC+ - SKM - å¤–å¸³
            const difference = paymentTotal - preSaleSettlement - acPlus - skmAmount - externalAccount;

            // ç¢ºä¿åªå–å…©ä½å°æ•¸é»ï¼Œé¿å…æµ®é»æ•¸èª¤å·®
            return parseFloat(difference.toFixed(2));
        }

        // --- 3. æ›´æ–° UI é¡¯ç¤º ---
        function updateUI() {
            const difference = calculateDifference();
            
            // å·®ç•°é¡¯ç¤ºä¹Ÿå¥—ç”¨åƒåˆ†ä½ç¬¦è™Ÿ
            DIFF_VALUE_EL.textContent = difference.toLocaleString('en-US');

            DIFF_VALUE_EL.classList.remove('bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800', 'text-gray-600');
            STATUS_EL.classList.remove('text-green-600', 'text-red-600');

            if (difference === 0) {
                DIFF_VALUE_EL.classList.add('bg-green-100', 'text-green-800');
                STATUS_EL.textContent = 'ğŸ¥³ YA! æ²’æœ‰å¸³å·®ï¼';
                STATUS_EL.classList.add('text-green-600');
            } else {
                // æ ¹æ“šå·®ç•°çš„æ­£è² å€¼é¡¯ç¤ºè§£è®€
                DIFF_VALUE_EL.classList.add('bg-red-100', 'text-red-800');
                if (difference > 0) {
                    STATUS_EL.textContent = `ğŸš¨ å·®ç•° +${difference.toLocaleString('en-US')} (æ–°å…‰å°‘æ”¶éŒ¢ï¼Œæ˜ç´°æœªé€€)`;
                } else {
                    STATUS_EL.textContent = `ğŸš¨ å·®ç•° ${difference.toLocaleString('en-US')} (æ–°å…‰å¤šæ”¶éŒ¢ï¼Œæ˜ç´°æœªå…¥)`;
                }
                STATUS_EL.classList.add('text-red-600');
            }
        }

        // --- 4. Firestore æ•¸æ“šæ“ä½œ ---

        // å–å¾—å–®ä¸€æ–‡ä»¶è·¯å¾‘ (Private Data)
        function getDocRef() {
            if (!db || !userId) return null;
            // è·¯å¾‘ï¼š/artifacts/{appId}/users/{userId}/reconciliation_tool/current_state
            return doc(db, 'artifacts', appId, 'users', userId, 'reconciliation_tool', 'current_state');
        }

        // å„²å­˜æ•¸æ“šåˆ° Firestore
        async function saveData() {
            if (!isAuthReady) return; // ç¢ºä¿èªè­‰å®Œæˆ
            
            const docRef = getDocRef();
            if (!docRef) return;

            const dataToSave = {};
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                // 1. unformat the string (å»é™¤åƒåˆ†ä½ç¬¦è™Ÿ)
                const unformattedStr = unformatNumber(inputEl.value);
                // 2. convert to number for storage (å„²å­˜ç´”æ•¸å­—)
                const value = parseFloat(unformattedStr) || 0;
                dataToSave[id] = value;
            });

            try {
                // ä½¿ç”¨ setDoc è¦†å¯«æˆ–å‰µå»ºæ–‡ä»¶
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // å¾ Firestore è¼‰å…¥æ•¸æ“šä¸¦è¨­å®šå³æ™‚ç›£è½
        function loadData() {
            const docRef = getDocRef();
            if (!docRef) return;

            // è¨­ç½® onSnapshot ç›£è½å™¨ä»¥å¯¦æ™‚ç²å–æ•¸æ“š
            onSnapshot(docRef, (docSnapshot) => {
                LOADING_EL.style.display = 'none'; // éš±è—è¼‰å…¥æç¤º
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // å°‡æ•¸æ“šå¡«å……å›è¼¸å…¥æ¡†
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if (data[id] !== undefined && inputEl) {
                            const numericValue = data[id];
                            if (numericValue !== 0) {
                                // è¼‰å…¥æ™‚ï¼Œå¥—ç”¨åƒåˆ†ä½ç¬¦è™Ÿæ ¼å¼
                                inputEl.value = formatNumberWithCommas(numericValue);
                            } else {
                                // å¦‚æœç‚º 0ï¼Œå‰‡é¡¯ç¤ºç©ºç™½
                                inputEl.value = '';
                            }
                        }
                    });
                    console.log("Data loaded from Firestore successfully.");
                } else {
                    console.log("No data found, using default empty values.");
                }
                // ç„¡è«–è¼‰å…¥æˆåŠŸèˆ‡å¦ï¼Œéƒ½æ‡‰æ›´æ–° UI
                updateUI();
            }, (error) => {
                console.error("Error listening to Firestore data:", error);
                LOADING_EL.textContent = 'è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚';
                updateUI(); // ä»ç„¶ä½¿ç”¨ç•¶å‰è¼¸å…¥å€¼é€²è¡Œè¨ˆç®—
            });
        }

        // --- 5. äº‹ä»¶ç›£è½å™¨å’Œåˆå§‹åŒ– ---

        function setupEventListeners() {
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                if (inputEl) {
                    // ç›£è½è¼¸å…¥è®ŠåŒ–ï¼Œå³æ™‚æ›´æ–° UI å’Œæ ¼å¼
                    inputEl.addEventListener('input', function() {
                        // 1. å–å¾—ç•¶å‰æ¸¸æ¨™ä½ç½®
                        const caretPos = this.selectionStart;
                        // 2. è¨ˆç®—æ¸¸æ¨™å‰èˆŠé€—è™Ÿçš„æ•¸é‡
                        const oldCommas = (this.value.substring(0, caretPos).match(/,/g) || []).length;
                        
                        // 3. æ ¼å¼åŒ–æ•¸å€¼
                        const cleanedValue = unformatNumber(this.value);
                        const formattedValue = formatNumberWithCommas(cleanedValue);
                        this.value = formattedValue;
                        
                        // 4. è¨ˆç®—æ ¼å¼åŒ–å¾Œæ–°çš„æ¸¸æ¨™ä½ç½®
                        const newCommas = (this.value.substring(0, this.selectionStart).match(/,/g) || []).length;
                        const newCaretPos = caretPos + (newCommas - oldCommas);
                        // é¿å…æ¸¸æ¨™è·‘åˆ°é‚Šç•Œå¤–
                        this.setSelectionRange(newCaretPos, newCaretPos);

                        // æ›´æ–°è¨ˆç®—å’Œå„²å­˜
                        updateUI();
                        // ä½¿ç”¨ setTimeout é€²è¡Œç°¡å–®çš„å»æŠ–å‹• (debounce) ä»¥æ¸›å°‘å¯«å…¥æ¬¡æ•¸
                        clearTimeout(this.saveTimer);
                        this.saveTimer = setTimeout(saveData, 500);
                    });
                }
            });
        }

        // Firebase åˆå§‹åŒ–å’Œèªè­‰æµç¨‹
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                LOADING_EL.textContent = 'Firebase é…ç½®ç¼ºå¤±ï¼Œæ•¸æ“šç„¡æ³•ä¿å­˜ã€‚';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // è™•ç†èªè­‰
                await new Promise((resolve) => {
                    // Firebase Auth ç‹€æ…‹è®Šæ›´ç›£è½
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // åªéœ€è¦ç›£è½ä¸€æ¬¡
                        if (user) {
                            userId = user.uid;
                        } else {
                            // ä½¿ç”¨æä¾›çš„ custom token ç™»å…¥ï¼Œå¦‚æœæ²’æœ‰å‰‡åŒ¿åç™»å…¥
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                console.log("Firebase Auth Ready. User ID:", userId);
                // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹è¼‰å…¥å’Œç›£è½æ•¸æ“š
                loadData();
                
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                LOADING_EL.textContent = 'Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—ã€‚';
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.onload = function() {
            setupEventListeners();
            // åœ¨å˜—è©¦è¼‰å…¥æ•¸æ“šå‰ï¼Œå…ˆé€²è¡Œåˆå§‹è¨ˆç®—å’Œ UI æ›´æ–° (ä½¿ç”¨é è¨­æˆ– HTML ä¸­çš„å€¼)
            updateUI();
            initializeFirebase();
        };

    </script>
</body>
</html>

