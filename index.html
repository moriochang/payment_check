<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­è²¡å‹™å°å¸³è¨ˆç®—æ©Ÿ - çµ‚ç«¯æ©Ÿæ¨¡å¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. å®šç¾©éœ“è™¹é¡è‰²èˆ‡å‹•ç•« Keyframes --- */
        :root {
            --neon-cyan: #00ffff; /* Primary active color */
            --neon-fuchsia: #ff00ff; /* Secondary alert color */
            --neon-success: #00ff99; /* Success color */
            --bg-dark: #050505; /* Near Black */
            --border-color: rgba(0, 255, 255, 0.4);
        }

        @keyframes flicker {
            0%, 19.99%, 21.99%, 23.99%, 54.99%, 56.99%, 100% {
                text-shadow: 0 0 5px var(--neon-cyan), 0 0 15px var(--neon-cyan);
                opacity: 1;
            }
            20%, 22%, 24%, 55%, 57% {
                text-shadow: none;
                opacity: 0.8;
            }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px rgba(0, 255, 255, 0.5); }
            50% { box-shadow: 0 0 15px var(--neon-cyan), 0 0 30px rgba(0, 255, 255, 0.8); }
        }
        
        @keyframes error-pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--neon-fuchsia), 0 0 20px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 15px var(--neon-fuchsia), 0 0 30px rgba(255, 0, 255, 0.8); }
        }

        @keyframes error-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* --- 2. æ‡‰ç”¨å…¨åŸŸæ¨£å¼èˆ‡æ•ˆæœ --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark); 
            color: #c0c0c0; /* Standard text color */
            /* subtle CRT scanline effect */
            background-image: linear-gradient(rgba(0,0,0,0.2) 1px, transparent 1px);
            background-size: 100% 4px;
        }

        /* æ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼šè„ˆè¡é‚Šæ¡† */
        #app-container {
            background-color: #121212; 
            border: 3px solid var(--border-color); 
            animation: pulse-glow 3s infinite alternate; /* Default neutral pulse */
        }
        
        /* æ¨™é¡Œèˆ‡é‡é»æ–‡å­—çš„éœ“è™¹ç™¼å…‰æ•ˆæœ */
        .neon-text-glow {
            text-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan);
            animation: flicker 4s infinite step-end;
        }
        
        /* è¼¸å…¥æ¬„ä½æ¨£å¼ */
        .standard-digit-input {
            font-family: 'Inter', sans-serif; 
            font-size: 1.25rem;
            font-weight: 700;
            background-color: #1a1a1a;
            color: var(--neon-cyan);
            border-color: #333;
            /* ç„¦é»æ™‚çš„éœ“è™¹é‚Šæ¡† */
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .standard-digit-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 5px var(--neon-cyan);
        }

        /* å·®ç•°é¡¯ç¤ºå€ */
        #difference-display {
            background-color: #000000;
            border: 3px solid var(--neon-cyan);
        }

        /* éŒ¯èª¤è­¦å ±ç‹€æ…‹ */
        .diff-error-state {
            border-color: var(--neon-fuchsia) !important;
            /* çµåˆæ–æ™ƒå’ŒéŒ¯èª¤è„ˆè¡ */
            animation: error-pulse-glow 1.5s infinite alternate, error-shake 0.2s 3; 
        }

        /* æˆåŠŸå¹³å¸³ç‹€æ…‹ */
        .diff-success-state {
            border-color: var(--neon-success) !important;
            box-shadow: 0 0 10px var(--neon-success), 0 0 30px rgba(0, 255, 153, 0.6) !important;
            animation: none; /* æˆåŠŸå¾Œåœæ­¢è„ˆè¡ */
        }
        
        /* å·®ç•°æ•¸å­—æœ¬èº« */
        .difference-digit-display {
            font-family: 'Inter', sans-serif;
            font-weight: 900;
        }

    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-xl rounded-2xl p-6 sm:p-8">
        
        <h1 class="text-3xl font-extrabold text-white mb-6 text-center border-b pb-3 border-gray-700 neon-text-glow">
            ğŸ“Š F.I.N.A.N.C.E. å°å¸³å„€è¡¨æ¿
        </h1>

        <div class="bg-gray-800 border-l-4 border-[#00ff99] text-[#00ff99] p-4 rounded-lg mb-6 shadow-md">
            <p class="font-bold mb-2 text-lg">å°å¸³ç›®æ¨™ï¼š<span class="text-white">å·®ç•°ç‚º 0</span></p>
            <p class="text-sm font-medium italic text-gray-400">
                å…¬å¼ï¼š(POS æ”¶å…¥) - (é å”®çµå¸³ + AC+) - (SKM1 + SKM2 + ç†Ÿå®¢ + å¤–å¸³) = å·®ç•°
            </p>
            <ul class="list-disc list-inside mt-3 text-sm space-y-1">
                <li class="text-[#00ff99]"><span class="font-bold text-white">æ­£å€¼ (+)</span>: ç³»çµ±æç¤ºï¼šæ–°å…‰å°‘æ”¶éŒ¢ (è¿½è¹¤æ˜ç´°é€€æ¬¾)</li>
                <li class="text-[#ff00ff]"><span class="font-bold text-white">è² å€¼ (-)</span>: ç³»çµ±æç¤ºï¼šæ–°å…‰å¤šæ”¶éŒ¢ (è¿½è¹¤æ˜ç´°å…¥å¸³)</li>
            </ul>
        </div>

        <div id="inputs-container" class="space-y-4">
            
            <h2 class="text-xl font-bold text-white pt-4 mb-2 border-t border-gray-800 neon-text-glow">POS</h2>
            <div class="grid grid-cols-3 gap-4">
                
                <div class="input-group col-span-3">
                    <label for="paymentTotal" class="block text-sm font-medium text-gray-300">Payment Total (ç¸½æ”¶å…¥)</label>
                    <input type="text" id="paymentTotal" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-inner standard-digit-input text-left font-bold">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="preSaleSettlement" class="block text-sm font-medium text-gray-300">é å”®çµå¸³ (æ¸›é …)</label>
                    <input type="text" id="preSaleSettlement" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>

                <div class="input-group">
                    <label for="acPlus" class="block text-sm font-medium text-gray-300">AC+ (æ¸›é …)</label>
                    <input type="text" id="acPlus" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-white pt-4 border-t border-gray-800 mt-6 mb-2 neon-text-glow">SKM</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="skm1Amount" class="block text-sm font-medium text-gray-300">SKM 1</label>
                    <input type="text" id="skm1Amount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>
                
                <div class="input-group">
                    <label for="skm2Amount" class="block text-sm font-medium text-gray-300">SKM 2</label>
                    <input type="text" id="skm2Amount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>

                <div class="input-group">
                    <label for="skmLoyalCustomer" class="block text-sm font-medium text-gray-300">SKM ç†Ÿå®¢</label>
                    <input type="text" id="skmLoyalCustomer" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>
                
                <div class="input-group">
                    <label for="externalAccount" class="block text-sm font-medium text-gray-300">å¤–å¸³</label>
                    <input type="text" id="externalAccount" inputmode="decimal"
                        class="mt-1 block w-full px-4 py-3 border rounded-lg shadow-sm standard-digit-input text-left">
                </div>
            </div>
        </div>

        <div class="mt-10 pt-6 border-t border-gray-700">
            <h2 class="text-xl font-bold text-white mb-4 text-center">ğŸ‰ æœ€çµ‚å°å¸³çµæœ (ERROR LEVEL) ğŸ‰</h2>
            <div id="difference-display" class="p-6 rounded-xl shadow-xl text-center transition duration-300 ease-in-out bg-gray-900 border">
                <p class="text-7xl difference-digit-display transition-colors duration-300 text-white" id="difference-value">-</p>
            </div>
            <p id="reconciliation-status" class="mt-4 text-center text-xl font-semibold text-slate-200">è«‹è¼¸å…¥æ•¸å­—ä»¥é–‹å§‹å°å¸³...</p>
        </div>

        <p id="loading-status" class="mt-6 text-center text-sm text-gray-500">
            <span class="animate-pulse text-yellow-500">æ•¸æ“šåŒæ­¥ä¸­...</span>
        </p>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ç‚º Debug (å¯é¸)
        setLogLevel('Debug');

        // --- 1. åˆå§‹åŒ– Firebase ç›¸é—œå¸¸æ•¸å’Œè®Šæ•¸ ---
        let db, auth, userId;
        let isAuthReady = false;
        
        // å¾ Canvas ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const INPUT_IDS = ['paymentTotal', 'preSaleSettlement', 'acPlus', 'skm1Amount', 'skm2Amount', 'externalAccount', 'skmLoyalCustomer'];
        const DIFF_VALUE_EL = document.getElementById('difference-value');
        const DIFF_DISPLAY_EL = document.getElementById('difference-display'); 
        const STATUS_EL = document.getElementById('reconciliation-status');
        const LOADING_EL = document.getElementById('loading-status');
        
        // --- Helper å‡½æ•¸ï¼šè™•ç†æ•¸å­—æ ¼å¼åŒ– ---

        /**
         * ç§»é™¤æ•¸å­—å­—ä¸²ä¸­çš„æ‰€æœ‰éæ•¸å­—å­—ç¬¦ï¼ˆåŒ…å«åƒåˆ†ä½ç¬¦è™Ÿï¼‰ï¼Œä½†ä¿ç•™å°æ•¸é»å’Œè² è™Ÿã€‚
         * @param {string | number} value - å¾…æ¸…ç†çš„å€¼ã€‚
         * @returns {string} æ¸…ç†å¾Œçš„æ•¸å­—å­—ä¸²ã€‚
         */
        function unformatNumber(value) {
            if (typeof value !== 'string') value = String(value);
            // å…è¨±æ•¸å­—ã€å°æ•¸é»å’Œé–‹é ­çš„è² è™Ÿ
            const cleaned = value.replace(/,/g, ''); // ç§»é™¤æ‰€æœ‰é€—è™Ÿ
            let result = cleaned.replace(/[^-0-9.]/g, '');
            if (result.indexOf('-') > 0) {
                result = result.replace(/-/g, '');
            }
            if ((result.match(/\./g) || []).length > 1) {
                const parts = result.split('.');
                result = parts.shift() + '.' + parts.join('');
            }
            return result;
        }

        /**
         * æª¢æŸ¥æ˜¯å¦æ‰€æœ‰è¼¸å…¥æ¬„ä½çš„è¦–è¦ºå€¼éƒ½ç‚ºç©ºå­—ä¸²ã€‚
         */
        function isInitialState() {
            return INPUT_IDS.every(id => {
                const inputEl = document.getElementById(id);
                return inputEl && inputEl.value === '';
            });
        }

        function calculateDifference() {
            // å¾è¼¸å…¥æ¡†ç²å–æ•¸å€¼ (ç©ºå­—ä¸²è½‰ç‚º 0)
            const paymentTotal = parseFloat(unformatNumber(document.getElementById('paymentTotal').value)) || 0;
            const preSaleSettlement = parseFloat(unformatNumber(document.getElementById('preSaleSettlement').value)) || 0;
            const acPlus = parseFloat(unformatNumber(document.getElementById('acPlus').value)) || 0;
            const skm1Amount = parseFloat(unformatNumber(document.getElementById('skm1Amount').value)) || 0; 
            const skm2Amount = parseFloat(unformatNumber(document.getElementById('skm2Amount').value)) || 0; 
            const externalAccount = parseFloat(unformatNumber(document.getElementById('externalAccount').value)) || 0;
            const skmLoyalCustomer = parseFloat(unformatNumber(document.getElementById('skmLoyalCustomer').value)) || 0; 

            // è¨ˆç®—å·®ç•°
            const difference = paymentTotal
                             - (preSaleSettlement + acPlus)
                             - (skm1Amount + skm2Amount + skmLoyalCustomer + externalAccount);

            return parseFloat(difference.toFixed(2));
        }

        // --- 3. æ›´æ–° UI é¡¯ç¤º (èª¿æ•´å‹•ç•«é‚è¼¯) ---
        function updateUI() {
            const difference = calculateDifference();
            const initialState = isInitialState(); 
            
            // ç§»é™¤æ‰€æœ‰é¡è‰²/å‹•ç•«é¡åˆ¥ï¼Œä¿æŒæ¸…æ½”
            DIFF_DISPLAY_EL.classList.remove('diff-error-state', 'diff-success-state');
            DIFF_VALUE_EL.classList.remove('text-[#00ff99]', 'text-[#ff00ff]', 'text-white');
            STATUS_EL.classList.remove('text-[#00ff99]', 'text-[#ff00ff]', 'text-slate-200');

            if (initialState) {
                // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºä¸­æ€§ç¬¦è™Ÿï¼Œä¸¦æ‡‰ç”¨é è¨­çš„è„ˆè¡å‹•ç•«
                DIFF_VALUE_EL.textContent = '-'; 
                DIFF_VALUE_EL.classList.add('text-white');
                STATUS_EL.classList.add('text-slate-200');
                STATUS_EL.textContent = 'è«‹è¼¸å…¥æ•¸å­—ä»¥é–‹å§‹å°å¸³...';
                
                // ç”±æ–¼å®¹å™¨é è¨­å·²æ‡‰ç”¨ pulse-glowï¼Œé€™è£¡ä¸éœ€è¦ç‰¹åˆ¥æ·»åŠ 
                return; 
            }
            
            // éåˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤ºè¨ˆç®—çµæœ
            DIFF_VALUE_EL.textContent = difference.toLocaleString('en-US');

            if (difference === 0) {
                // å¹³å¸³ - æˆåŠŸç‹€æ…‹
                DIFF_DISPLAY_EL.classList.add('diff-success-state'); 
                DIFF_VALUE_EL.classList.add('text-[#00ff99]');
                STATUS_EL.textContent = 'âœ… æ­å–œï¼æ•¸æ“šåŒæ­¥æˆåŠŸï¼Œå°å¸³ç„¡å·®ç•°ï¼';
                STATUS_EL.classList.add('text-[#00ff99]');
            } else {
                // éé›¶å·®ç•° - éŒ¯èª¤è­¦å ±ç‹€æ…‹
                DIFF_DISPLAY_EL.classList.add('diff-error-state'); 
                DIFF_VALUE_EL.classList.add('text-[#ff00ff]'); // éœ“è™¹ç²‰è‰²

                if (difference > 0) {
                    STATUS_EL.textContent = `ğŸš¨ éŒ¯èª¤ç´šåˆ¥ï¼š+${difference.toLocaleString('en-US')} (æ–°å…‰å°‘æ”¶éŒ¢ï¼Œéœ€è¿½è¹¤æ˜ç´°)`;
                } else {
                    STATUS_EL.textContent = `ğŸš¨ éŒ¯èª¤ç´šåˆ¥ï¼š${difference.toLocaleString('en-US')} (æ–°å…‰å¤šæ”¶éŒ¢ï¼Œéœ€è¿½è¹¤æ˜ç´°)`;
                }
                STATUS_EL.classList.add('text-[#ff00ff]');
            }
        }

        // --- 4. Firestore æ•¸æ“šæ“ä½œ (ä¿æŒä¸è®Š) ---

        function getDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'reconciliation_tool', 'current_state');
        }

        async function saveData() {
            if (!isAuthReady) return;
            const docRef = getDocRef();
            if (!docRef) return;

            const dataToSave = {};
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                const unformattedStr = unformatNumber(inputEl.value);
                const value = parseFloat(unformattedStr) || 0;
                dataToSave[id] = value;
            });

            try {
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        function loadData() {
            const docRef = getDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnapshot) => {
                LOADING_EL.style.display = 'none';
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if (data[id] !== undefined && inputEl) {
                            const numericValue = data[id];
                            if (numericValue !== 0) {
                                inputEl.value = numericValue.toString();
                            } else {
                                inputEl.value = ''; 
                            }
                        }
                    });
                    console.log("Data loaded from Firestore successfully.");
                } else {
                    console.log("No data found, using default '' values.");
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if(inputEl) inputEl.value = '';
                    });
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to Firestore data:", error);
                LOADING_EL.textContent = 'è¼‰å…¥æ•¸æ“šå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚';
                updateUI();
            });
        }

        // --- 5. äº‹ä»¶ç›£è½å™¨å’Œåˆå§‹åŒ– (ä¿æŒå–®å…ƒæ ¼æ¸…é›¶é‚è¼¯ä¸è®Š) ---

        function setupEventListeners() {
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                if (inputEl) {
                    inputEl.addEventListener('input', function() {
                        const caretPos = this.selectionStart;
                        const cleanedValue = unformatNumber(this.value);
                        this.value = cleanedValue;
                        this.setSelectionRange(caretPos, caretPos);

                        updateUI();
                        clearTimeout(this.saveTimer);
                        this.saveTimer = setTimeout(saveData, 500);
                    });
                    
                    inputEl.addEventListener('blur', function() {
                        // åªè¦å€¼æ˜¯ ''ã€'-'ã€'.' æˆ– '0'ï¼Œå°±å¼·åˆ¶è¨­å®šç‚ºç©ºå­—ä¸² ''
                        if (this.value === '' || this.value === '-' || this.value === '.' || this.value === '0') {
                            this.value = '';
                            
                            updateUI();
                            saveData();
                        }
                    });
                }
            });
        }

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                LOADING_EL.textContent = 'Firebase é…ç½®ç¼ºå¤±ï¼Œæ•¸æ“šç„¡æ³•ä¿å­˜ã€‚';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe();
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                console.log("Firebase Auth Ready. User ID:", userId);
                loadData();
                
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                LOADING_EL.textContent = 'Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—ã€‚';
            }
        }
        
        window.onload = function() {
            setupEventListeners();
            updateUI();
            initializeFirebase();
        };

    </script>
</body>
</html>
