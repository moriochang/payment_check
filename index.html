<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>對帳小工具</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 確保字體為 Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* 隱藏 Chrome/Safari 的數字輸入框箭頭 (雖然已改為 text，但保留以防萬一) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* 隱藏 Firefox 的數字輸入框箭頭 */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            🧾 對帳計算機
        </h1>

        <!-- 說明區塊 -->
        <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg mb-6">
            <p class="font-bold mb-1">對帳目標：差異為 0</p>
            <!-- 更新公式顯示 -->
            <p class="text-sm font-semibold">對帳公式：Payment Total - 預售結帳 - AC+ = SKM + 外帳</p>
            <ul class="list-disc list-inside mt-2 text-sm space-y-1">
                <li><span class="font-bold text-green-700">差異為 +</span>: 新光少收錢 (或明細未退)</li>
                <li><span class="font-bold text-red-700">差異為 -</span>: 新光多收錢 (或明細未入)</li>
            </ul>
        </div>

        <div id="inputs-container" class="space-y-4">
            <!-- Payment Total (已改為 type="text" 並靠左) -->
            <div class="input-group">
                <label for="paymentTotal" class="block text-sm font-medium text-gray-700">Payment Total</label>
                <input type="text" id="paymentTotal" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- 預售結帳 (已改為 type="text" 並靠左) -->
            <div class="input-group">
                <label for="preSaleSettlement" class="block text-sm font-medium text-gray-700">預售結帳</label>
                <input type="text" id="preSaleSettlement" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- AC+ (已改為 type="text" 並靠左) -->
            <div class="input-group">
                <label for="acPlus" class="block text-sm font-medium text-gray-700">AC+</label>
                <input type="text" id="acPlus" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>

            <!-- SKM (已改為 type="text" 並靠左) -->
            <div class="input-group">
                <label for="skmAmount" class="block text-sm font-medium text-gray-700">SKM</label>
                <input type="text" id="skmAmount" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>
            
            <!-- 外帳 (已改為 type="text" 並靠左) -->
            <div class="input-group">
                <label for="externalAccount" class="block text-sm font-medium text-gray-700">外帳</label>
                <input type="text" id="externalAccount" placeholder="0" value=""
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-lg font-mono text-left">
            </div>
        </div>

        <!-- 差異結果顯示 -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 text-center">最終差異 (Difference)</h2>
            <div id="difference-display" class="p-5 rounded-xl shadow-inner text-center">
                <!-- 差異值將在此顯示 -->
                <p class="text-5xl font-extrabold font-mono" id="difference-value">0</p>
            </div>
            <p id="reconciliation-status" class="mt-3 text-center text-lg font-medium"></p>
        </div>

        <p id="loading-status" class="mt-4 text-center text-sm text-gray-500">
            <!-- 載入狀態顯示 -->
            <span class="animate-pulse">數據載入中...</span>
        </p>

    </div>

    <!-- Firebase 腳本 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // 設置日誌級別為 Debug (可選)
        setLogLevel('Debug');

        // --- 1. 初始化 Firebase 相關常數和變數 ---
        let db, auth, userId;
        let isAuthReady = false;
        
        // 從 Canvas 環境變數獲取配置
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 更新 INPUT_IDS 以包含所有欄位
        const INPUT_IDS = ['paymentTotal', 'preSaleSettlement', 'acPlus', 'skmAmount', 'externalAccount'];
        const DIFF_VALUE_EL = document.getElementById('difference-value');
        const STATUS_EL = document.getElementById('reconciliation-status');
        const LOADING_EL = document.getElementById('loading-status');
        
        // --- Helper 函數：處理數字格式化 ---

        /**
         * 移除數字字串中的所有非數字字符（包含千分位符號），但保留小數點和負號。
         * @param {string | number} value - 待清理的值。
         * @returns {string} 清理後的數字字串。
         */
        function unformatNumber(value) {
            if (typeof value !== 'string') value = String(value);
            // 允許數字、小數點和開頭的負號
            const cleaned = value.replace(/,/g, ''); // 移除所有逗號
            return cleaned.replace(/[^0-9.-]/g, '');
        }

        /**
         * 將數字或數字字串格式化為帶有千位數分隔符號的字串。
         * @param {string | number} value - 待格式化的值。
         * @returns {string} 帶有千分位符號的字串。
         */
        function formatNumberWithCommas(value) {
            const cleanedValue = unformatNumber(value);
            if (cleanedValue === '' || cleanedValue === '-') return cleanedValue;

            // 使用 Intl.NumberFormat 確保準確的千分位格式
            // 使用 'en-US' 確保使用逗號作為千分位分隔符
            return new Intl.NumberFormat('en-US').format(parseFloat(cleanedValue));
        }

        // --- 2. 核心計算邏輯 ---
        function calculateDifference() {
            // 從輸入框獲取數值 (先去除千分位符號)，如果為空則視為 0
            const paymentTotalStr = unformatNumber(document.getElementById('paymentTotal').value);
            const preSaleSettlementStr = unformatNumber(document.getElementById('preSaleSettlement').value);
            const acPlusStr = unformatNumber(document.getElementById('acPlus').value);
            const skmAmountStr = unformatNumber(document.getElementById('skmAmount').value);
            const externalAccountStr = unformatNumber(document.getElementById('externalAccount').value);

            // 轉換為浮點數進行計算
            const paymentTotal = parseFloat(paymentTotalStr) || 0;
            const preSaleSettlement = parseFloat(preSaleSettlementStr) || 0;
            const acPlus = parseFloat(acPlusStr) || 0;
            const skmAmount = parseFloat(skmAmountStr) || 0;
            const externalAccount = parseFloat(externalAccountStr) || 0;

            // 計算差異：Payment Total 減去所有費用項目
            // 差異 = Payment Total - 預售結帳 - AC+ - SKM - 外帳
            const difference = paymentTotal - preSaleSettlement - acPlus - skmAmount - externalAccount;

            // 確保只取兩位小數點，避免浮點數誤差
            return parseFloat(difference.toFixed(2));
        }

        // --- 3. 更新 UI 顯示 ---
        function updateUI() {
            const difference = calculateDifference();
            
            // 差異顯示也套用千分位符號
            DIFF_VALUE_EL.textContent = difference.toLocaleString('en-US');

            DIFF_VALUE_EL.classList.remove('bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800', 'text-gray-600');
            STATUS_EL.classList.remove('text-green-600', 'text-red-600');

            if (difference === 0) {
                DIFF_VALUE_EL.classList.add('bg-green-100', 'text-green-800');
                STATUS_EL.textContent = '🥳 YA! 沒有帳差！';
                STATUS_EL.classList.add('text-green-600');
            } else {
                // 根據差異的正負值顯示解讀
                DIFF_VALUE_EL.classList.add('bg-red-100', 'text-red-800');
                if (difference > 0) {
                    STATUS_EL.textContent = `🚨 差異 +${difference.toLocaleString('en-US')} (新光少收錢，明細未退)`;
                } else {
                    STATUS_EL.textContent = `🚨 差異 ${difference.toLocaleString('en-US')} (新光多收錢，明細未入)`;
                }
                STATUS_EL.classList.add('text-red-600');
            }
        }

        // --- 4. Firestore 數據操作 ---

        // 取得單一文件路徑 (Private Data)
        function getDocRef() {
            if (!db || !userId) return null;
            // 路徑：/artifacts/{appId}/users/{userId}/reconciliation_tool/current_state
            return doc(db, 'artifacts', appId, 'users', userId, 'reconciliation_tool', 'current_state');
        }

        // 儲存數據到 Firestore
        async function saveData() {
            if (!isAuthReady) return; // 確保認證完成
            
            const docRef = getDocRef();
            if (!docRef) return;

            const dataToSave = {};
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                // 1. unformat the string (去除千分位符號)
                const unformattedStr = unformatNumber(inputEl.value);
                // 2. convert to number for storage (儲存純數字)
                const value = parseFloat(unformattedStr) || 0;
                dataToSave[id] = value;
            });

            try {
                // 使用 setDoc 覆寫或創建文件
                await setDoc(docRef, dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
            }
        }

        // 從 Firestore 載入數據並設定即時監聽
        function loadData() {
            const docRef = getDocRef();
            if (!docRef) return;

            // 設置 onSnapshot 監聽器以實時獲取數據
            onSnapshot(docRef, (docSnapshot) => {
                LOADING_EL.style.display = 'none'; // 隱藏載入提示
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // 將數據填充回輸入框
                    INPUT_IDS.forEach(id => {
                        const inputEl = document.getElementById(id);
                        if (data[id] !== undefined && inputEl) {
                            const numericValue = data[id];
                            if (numericValue !== 0) {
                                // 載入時，套用千分位符號格式
                                inputEl.value = formatNumberWithCommas(numericValue);
                            } else {
                                // 如果為 0，則顯示空白
                                inputEl.value = '';
                            }
                        }
                    });
                    console.log("Data loaded from Firestore successfully.");
                } else {
                    console.log("No data found, using default empty values.");
                }
                // 無論載入成功與否，都應更新 UI
                updateUI();
            }, (error) => {
                console.error("Error listening to Firestore data:", error);
                LOADING_EL.textContent = '載入數據失敗，請稍後重試。';
                updateUI(); // 仍然使用當前輸入值進行計算
            });
        }

        // --- 5. 事件監聽器和初始化 ---

        function setupEventListeners() {
            INPUT_IDS.forEach(id => {
                const inputEl = document.getElementById(id);
                if (inputEl) {
                    // 監聽輸入變化，即時更新 UI 和格式
                    inputEl.addEventListener('input', function() {
                        // 1. 取得當前游標位置
                        const caretPos = this.selectionStart;
                        // 2. 計算游標前舊逗號的數量
                        const oldCommas = (this.value.substring(0, caretPos).match(/,/g) || []).length;
                        
                        // 3. 格式化數值
                        const cleanedValue = unformatNumber(this.value);
                        const formattedValue = formatNumberWithCommas(cleanedValue);
                        this.value = formattedValue;
                        
                        // 4. 計算格式化後新的游標位置
                        const newCommas = (this.value.substring(0, this.selectionStart).match(/,/g) || []).length;
                        const newCaretPos = caretPos + (newCommas - oldCommas);
                        // 避免游標跑到邊界外
                        this.setSelectionRange(newCaretPos, newCaretPos);

                        // 更新計算和儲存
                        updateUI();
                        // 使用 setTimeout 進行簡單的去抖動 (debounce) 以減少寫入次數
                        clearTimeout(this.saveTimer);
                        this.saveTimer = setTimeout(saveData, 500);
                    });
                }
            });
        }

        // Firebase 初始化和認證流程
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                LOADING_EL.textContent = 'Firebase 配置缺失，數據無法保存。';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 處理認證
                await new Promise((resolve) => {
                    // Firebase Auth 狀態變更監聽
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // 只需要監聽一次
                        if (user) {
                            userId = user.uid;
                        } else {
                            // 使用提供的 custom token 登入，如果沒有則匿名登入
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } else {
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                console.log("Firebase Auth Ready. User ID:", userId);
                // 認證完成後，開始載入和監聽數據
                loadData();
                
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                LOADING_EL.textContent = 'Firebase 初始化或認證失敗。';
            }
        }
        
        // 頁面載入完成後執行
        window.onload = function() {
            setupEventListeners();
            // 在嘗試載入數據前，先進行初始計算和 UI 更新 (使用預設或 HTML 中的值)
            updateUI();
            initializeFirebase();
        };

    </script>
</body>
</html>

